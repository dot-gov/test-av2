

# ------------ FOGLIO DI STILE -------------- #

# 3 livelli: SYSTEM, VM, AGENT
# SYSTEM: // opzionale START_VM + STOP_VM
#    - INIT_
#    - END_
#    - SYSTEM_
# VM: // no START_VM, si' opzionale: START_AGENT + STOP_AGENT
#   - VM
# AGENT: // no START_VM, no START_AGENT
#   - AG_
#   - CHECK_
#   - *

# ----------- PARTIAL COMMANDS -------------- #

INIT_DISPATCH:
    - INTERNET: False
    - REVERT
    - START_VM: AV_AGENT
    # wait for av start
    - SLEEP: 60

END_DISPATCH:
    - STOP_VM: 60

# -------------- SERVER SET -------------- #

SET_MAIL:
    - SET_SERVER:
        mail_recipients: [zeno@hackingteam.com, seppia@hackingteam.com, m.losito@hackingteam.com]
        #mail_recipients: [m.losito@hackingteam.com]

# ------------- SYSTEM COMMANDS -------------- #

SYSTEM_STATIC_WINDOWS:
    - VM_ALL
    - INTERNET: False
    - SLEEP: [10, 120]
    - CROP: True
    - CALL: SET_MAIL
    - REPORT:
        - BUILD_WINDOWS
    - CROP: False
    - CALL: END_DISPATCH

SYSTEM_STATIC_MOBILE:
    - VM_ALL: IMPORTANT
    - INTERNET: False
    - SLEEP: [0, 600]
    - CLEAN_EVIDENCES: Ok
    - CROP: True
    - REPORT:
        - BUILD_MOBILE
    - CROP: False
    - CALL: END_DISPATCH

REVERT:
    - VM_ALL
    - INTERNET: False
    - SLEEP: [1, 10]
    - REVERT

SYSTEM_START:
    - VM_ALL
    - INTERNET: False
    - SLEEP: [1, 60]
    - START_VM

SYSTEM_STOP:
    - VM_ALL
    - STOP_VM: 60


#######################################################################
#######################################################################
#######################################################################
#            _______
#  |\     /|(       )
#  | )   ( || () () |
#  | |   | || || || |
#  ( (   ) )| |(_)| |
#   \ \_/ / | |   | |
#    \   /  | )   ( |
#     \_/   |/     \|
#
#######################################################################
#######################################################################
#######################################################################


#### ALL VM ARE NOT DIRECTLY CALLABLE ####
#### They have the init dispatch that is not usually used externally ####

VM_ELITE_FAST:
    - CALL: INIT_DISPATCH
    - BUILD: [ scout, windows, silent ]
    - SLEEP: 30
    - RELOG

    - ON_ERROR: CONTINUE
    - CROP: True
    - BUILD: [ elite_fast, windows, silent ]
    - CROP: False
    - SCREENSHOT
    #don't skip because I need to uninstall
    #- ON_ERROR: SKIP
    ##CHECKING IF UNINSTALLATION SUCCEDEED
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL
    #- RELOG

VM_ELITE_FAST_SRV:
    - CALL: INIT_DISPATCH
    - BUILD_SRV: [ scout, windows, silent, elite_fast ]
    - SLEEP: 30
    - RELOG

    - ON_ERROR: CONTINUE
    - CROP: True
    - BUILD_SRV: [ elite_fast, windows, silent, elite_fast ]
    - CROP: False
    - SCREENSHOT
    #don't skip because I need to uninstall
    #- ON_ERROR: SKIP
    ##CHECKING IF UNINSTALLATION SUCCEDEED
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL
    #- RELOG


VM_ELITE_FAST_DEMO_SRV:
    #andrebbe eseguito solo una volta a settimana
    - ENABLE: [ sunday ]
    #NB: no crop for DEMO
    - CALL: INIT_DISPATCH
    #- SLEEP: 60
    - BUILD_SRV: [ scout, windows_elite_demo, silent, elite_fast_demo ]
    - SCREENSHOT
    #this is always an elite and so it should sync in a minute
    - SLEEP: 90
    - EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL

VM_ELITE_FAST_SCOUTDEMO_SRV:
    #NB: no crop for DEMO
    - CALL: INIT_DISPATCH
    #- BUILD_SRV: [ scout, windows_demo, silent, elite_fast_scoutdemo ]
    - BUILD_SRV: [ scout, windows_demo, silent, elite_fast ]
    - SLEEP: 30
    - RELOG
    # i parametri: ACTION: elite_fast_scoutdemo (cioe' step 2 dello scoutdemo), CONFIG: windows_elite_demo cioe' upgrade ad elite ma in demo, TIPO: silent, FINAL_ACTION: elite_fast_scoutdemo
    - BUILD_SRV: [ elite_fast, windows_demo, silent, elite_fast ]
    - SCREENSHOT
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL



VM_SOLDIER:
    - CALL: INIT_DISPATCH
    - BUILD: [ scout, windows, silent ]
    - SLEEP: 30
    - RELOG

    - ON_ERROR: CONTINUE
    - CROP: True
    - BUILD: [ soldier_fast, windows, silent ]
    - CROP: False
    - SCREENSHOT
    #don't skip because I need to uninstall
    #- ON_ERROR: SKIP
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL
    #- RELOG


VM_SOLDIER_SRV:
    - CALL: INIT_DISPATCH
    - BUILD_SRV: [ scout, windows, silent, soldier_fast ]
    - SLEEP: 30
    - RELOG

    - ON_ERROR: CONTINUE
    - CROP: True
    - BUILD_SRV: [ soldier_fast, windows, silent, soldier_fast ]
    - CROP: False
    - SCREENSHOT
    #don't skip because I need to uninstall
    - ON_ERROR: SKIP
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL


VM_MELT:
    - CALL: INIT_DISPATCH
    - BUILD: [ scout, windows, melt ]
    - SCREENSHOT
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL


VM_MELT_SRV:
    - CALL: INIT_DISPATCH
    - BUILD_SRV: [ scout, windows, melt, melt ]
    - SCREENSHOT
    #before check infection, I need a sync (relog + 5 min wait)
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL

VM_MELT_SRV_FIF:
    - ENABLE: [ monday, thursday ]
    - CALL: INIT_DISPATCH
    - BUILD_SRV: [ scout, windows_melt_fif, melt, melt ]
    - SCREENSHOT
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL

VM_MELT_SRV_UTO:
    - ENABLE: [ tuesday, friday, sunday ]
    - CALL: INIT_DISPATCH
    - BUILD_SRV: [ scout, windows_melt_uto, melt, melt ]
    - SCREENSHOT
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL

VM_MELT_SRV_SKY:
    - ENABLE: [ wednesday, saturday ]
    - CALL: INIT_DISPATCH
    - BUILD_SRV: [ scout, windows_melt_sky, melt, melt ]
    - SCREENSHOT
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL


VM_EXPLOIT:
    - ON_ERROR: CONTINUE
    - CALL: INIT_DISPATCH
    - BUILD: [ pull, exploit, melt ]
    #- BUILD: [ pull, exploit_avi, melt ]
    #- BUILD: [ pull, exploit_bmp, melt ]
    #- BUILD: [ pull, exploit_eml, melt ]
    #- BUILD: [ pull, exploit_gif, melt ]
    #- BUILD: [ pull, exploit_html, melt ]
    #- BUILD: [ pull, exploit_jpg, melt ]
    #- BUILD: [ pull, exploit_mp3, melt ]
    #- BUILD: [ pull, exploit_png, melt ]
    #- BUILD: [ pull, exploit_vsd, melt ]
    #- BUILD: [ pull, exploit_doc, melt ]
    #- BUILD: [ pull, exploit_ppt, melt ]
    #- BUILD: [ pull, exploit_xls, melt ]
    #- BUILD: [ pull, exploit_rtf, melt ]
    #- BUILD: [ pull, exploit_exe, melt ]
    #- BUILD: [ pull, exploit_zip, melt ]
    #- BUILD: [ pull, exploit_rar, melt ]
    - BUILD: [ scout, exploit_pdf, melt ]
    - SCREENSHOT
    #before check infection, I need a sync (relog + 5 min wait)
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL
    - RELOG
    - BUILD: [ scout, selfdel_exploit, melt ]
    - SCREENSHOT
    #before check infection, I need a sync (relog + 5 min wait)
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL


VM_EXPLOIT_SRV:
    - ON_ERROR: CONTINUE
    - CALL: INIT_DISPATCH

    - BUILD_SRV: [ pull, exploit, melt, exploit ]
    - SCREENSHOT
    - BUILD_SRV: [ scout, exploit_pdf, melt, exploit_pdf ]
    - SCREENSHOT
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL
    - RELOG
    - BUILD_SRV: [ scout, selfdel_exploit, melt, selfdel_exploit ]
    - SCREENSHOT
    #- RELOG
    #- SLEEP: 300
    #- EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - CHECK_INFECTION
    #to be sure, we uninstall
    - UNINSTALL

 
VM_STATIC:
    - CALL: INIT_DISPATCH
    - CROP: True
    - ON_ERROR: CONTINUE
    - CALL: BUILD_DESKTOP
    - CALL: BUILD_MOBILE
    - CALL: BUILD_EXPLOIT
    - CROP: False
    - ON_ERROR: SKIP

VM_STATIC_SRV:
    - CALL: INIT_DISPATCH
    - CROP: True
    - ON_ERROR: CONTINUE
    - CALL: BUILD_DESKTOP_SRV
    - CALL: BUILD_MOBILE_SRV
    - CALL: BUILD_EXPLOIT_SRV
    - CROP: False
    - ON_ERROR: SKIP

#######################################################################
#######################################################################
#######################################################################
#   _______   _______ _____ ________  ___
#  /  ___\ \ / /  ___|_   _|  ___|  \/  |
#  \ `--. \ V /\ `--.  | | | |__ | .  . |
#   `--. \ \ /  `--. \ | | |  __|| |\/| |
#  /\__/ / | | /\__/ / | | | |___| |  | |
#  \____/  \_/ \____/  \_/ \____/\_|  |_/
#
#
#######################################################################
#######################################################################
#######################################################################


### 'SYSTEM_' Can be called directly - ARE USED ALSO FOR RETESTS

SYSTEM_STATIC:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_STATIC: ['AV Invisibility Static', 'Static check on builds']
    - CALL: END_DISPATCH


SYSTEM_STATIC_SRV:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    # init_dispatch needed for clean evidences (to be removed)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_STATIC_SRV: ['AV Invisibility Static', 'Static check on builds']
    - CALL: END_DISPATCH


SYSTEM_MELT:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_MELT: ['AV Invisibility', 'Melt']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: END_DISPATCH


SYSTEM_MELT_SRV:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    # init_dispatch needed for clean evidences (to be removed)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_MELT_SRV: ['AV Invisibility', 'Melt']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: END_DISPATCH


SYSTEM_MELT_SRV_FIF:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    - CALL: SET_MAIL
    - REPORT:
        - VM_MELT_SRV_FIF: ['AV Invisibility', 'Melt']
    - CALL: END_DISPATCH

SYSTEM_MELT_SRV_UTO:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    - CALL: SET_MAIL
    - REPORT:
        - VM_MELT_SRV_UTO: ['AV Invisibility', 'Melt']
    - CALL: END_DISPATCH

SYSTEM_MELT_SRV_SKY:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    - CALL: SET_MAIL
    - REPORT:
        - VM_MELT_SRV_SKY: ['AV Invisibility', 'Melt']
    - CALL: END_DISPATCH

SYSTEM_ELITE_FAST:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_ELITE_FAST: ['AV Invisibility', 'Elite']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH


SYSTEM_ELITE_FAST_SRV:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    # init_dispatch needed for clean evidences (to be removed)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_ELITE_FAST_SRV: ['AV Invisibility', 'Elite']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH
 

SYSTEM_ELITE_FAST_DEMO_SRV:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    # init_dispatch needed for clean evidences (to be removed)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_ELITE_FAST_DEMO_SRV: ['AV Invisibility', 'Elite_Demo']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH

SYSTEM_ELITE_FAST_SCOUTDEMO_SRV:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    # init_dispatch needed for clean evidences (to be removed)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_ELITE_FAST_SCOUTDEMO_SRV: ['AV Invisibility', 'Elite_Scout_Demo']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH

 
SYSTEM_ELITE:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    # init_dispatch needed for clean evidences (to be removed)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_ELITE: ['AV Invisibility', 'Elite']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: END_DISPATCH


SYSTEM_SOLDIER:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    # init_dispatch needed for clean evidences (to be removed)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_SOLDIER: ['AV Invisibility', 'Soldier']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH


SYSTEM_SOLDIER_SRV:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    # init_dispatch needed for clean evidences (to be removed)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_SOLDIER_SRV: ['AV Invisibility', 'Soldier']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH


SYSTEM_EXPLOIT:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_EXPLOIT: ['AV Invisibility', 'Exploit']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH


SYSTEM_EXPLOIT_SRV:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 600]
    # CLEAN_EV no more useful - instances are deleted during run and factories are deleted daily
    # init_dispatch needed for clean evidences (to be removed)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_EXPLOIT_SRV: ['AV Invisibility', 'Exploit']
    # moved in VM_procedures: screnshot and uninstall
    #- SCREENSHOT
    #- UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH

##########################################################################################
##########################################################################################
##########################################################################################
##########################################################################################
####
####                         ______   _______ _________ _
####                        (  __  \ (  ___  )\__   __/( \   |\     /|
####                        | (  \  )| (   ) |   ) (   | (   ( \   / )
####                        | |   ) || (___) |   | |   | |    \ (_) /
####                        | |   | ||  ___  |   | |   | |     \   /
####                        | |   ) || (   ) |   | |   | |      ) (
####                        | (__/  )| )   ( |___) (___| (____/\| |
####                        (______/ |/     \|\_______/(_______/\_/
####
##########################################################################################
##########################################################################################
##########################################################################################
##########################################################################################


#untested and unused since middle age
SYSTEM_DAILY:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 1800]
    - CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_STATIC: ['AV Invisibility Static', 'Static check on builds']
        - VM_SOLDIER: ['AV Invisibility', 'Soldier']
        - VM_ELITE_FAST: ['AV Invisibility', 'Elite']
        - VM_MELT: ['AV Invisibility', 'Melt']
        - VM_EXPLOIT: ['AV Invisibility', 'Exploit']
    - UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH


SYSTEM_DAILY_SRV:

    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 1800]
    #init is needed by clean_evidences (just here)
    - CALL: INIT_DISPATCH
    - CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    #qui cancello tutti i sample per la giornata!
    - BUILD_CACHE_CLEAN: False
    - REPORT:
        - VM_STATIC_SRV: ['AV Invisibility Static', 'Static check on builds']
        - VM_SOLDIER_SRV: ['AV Invisibility', 'Soldier']
        - VM_ELITE_FAST_SRV: ['AV Invisibility', 'Elite']
        - VM_ELITE_FAST_DEMO_SRV: ['AV Invisibility', 'Elite Demo']
        - VM_ELITE_FAST_SCOUTDEMO_SRV: ['AV Invisibility', 'Elite Scout Demo']
        #- VM_MELT_SRV: ['AV Invisibility', 'Melt']
        - VM_MELT_SRV_SKY: ['AV Invisibility', 'Melt']
        - VM_MELT_SRV_FIF: ['AV Invisibility', 'Melt']
        - VM_MELT_SRV_UTO: ['AV Invisibility', 'Melt']
        - VM_EXPLOIT_SRV: ['AV Invisibility', 'Exploit']
    #qui salvo tutti i sample per la giornata!
    - BUILD_CACHE_CLEAN: True
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH

#untested and unused since middle age
SYSTEM_DAILY_FAST:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 300]
    - CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_STATIC: ['AV Invisibility Static', 'Static check on builds']
        - VM_SOLDIER: ['AV Invisibility', 'Soldier']
        - VM_ELITE_FAST: ['AV Invisibility', 'Elite']
        - VM_MELT: ['AV Invisibility', 'Melt']
        - VM_EXPLOIT: ['AV Invisibility', 'Exploit']
    - UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH


SYSTEM_DAILY_FAST_SRV:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 300]
    #Clean evidences should be called only during nighttime automatic tests (next 2 commands have to be commented)
    #- CALL: INIT_DISPATCH
    #- CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    #qui cancello tutti i sample per la giornata!
    - BUILD_CACHE_CLEAN: False
    - REPORT:
        #- VM_STATIC_SRV: ['AV Invisibility Static', 'Static check on builds']
        #- VM_SOLDIER_SRV: ['AV Invisibility', 'Soldier']
        #- VM_ELITE_FAST_SRV: ['AV Invisibility', 'Elite']
        #- VM_ELITE_FAST_DEMO_SRV: ['AV Invisibility', 'Elite Demo']
        #- VM_ELITE_FAST_SCOUTDEMO_SRV: ['AV Invisibility', 'Elite Scout Demo']
        # permanently removed - VM_MELT_SRV: ['AV Invisibility', 'Melt']
        - VM_MELT_SRV_SKY: ['AV Invisibility', 'Melt']
        - VM_MELT_SRV_FIF: ['AV Invisibility', 'Melt']
        - VM_MELT_SRV_UTO: ['AV Invisibility', 'Melt']
        #- VM_EXPLOIT_SRV: ['AV Invisibility', 'Exploit']
    - UNINSTALL
    #qui salvo tutti i sample per la giornata!
    - BUILD_CACHE_CLEAN: True
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH

########################################################################
########################################################################
########################################################################
#    ____ _____  _  _____ ___ ____
#   / ___|_   _|/ \|_   _|_ _/ ___|
#   \___ \ | | / _ \ | |  | | |
#    ___) || |/ ___ \| |  | | |___
#   |____/ |_/_/   \_\_| |___\____|   (PARZIALE)
#
########################################################################
########################################################################
########################################################################


VM_STATIC_ANDROID:
    - CALL: INIT_DISPATCH
    - CROP: True
    - ON_ERROR: CONTINUE
    - CALL: BUILD_MOBILE
    - CROP: False
    - ON_ERROR: SKIP

#useful to test a static set of exes
VM_STATIC_AGENTS:
    - VM_ALL
    - CALL: INIT_DISPATCH
    - CROP: True
    - ON_ERROR: CONTINUE
    #- CALL: BUILD_MOBILE
    - REPORT:
        - CHECK_STATIC_MODULES_SCOUT_ICONS
    - CROP: False
    - ON_ERROR: SKIP

SYSTEM_ANDROID_FAST:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [1, 300]
    - CALL: VM_CLEAN_EVIDENCES
    - CALL: SET_MAIL
    - REPORT:
        - VM_STATIC_ANDROID: ['AV Invisibility Static', 'Static check on builds']

    - UNINSTALL
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH

# ------------  #

VM_PUSH_VIRUS:
    - ON_ERROR: CONTINUE
    - SLEEP: 300
    - CROP: True
    - PUSH: [ AVAgent/assets/vira/conficker.dll, AVAgent/assets/vira/eicar.com ]
    - SLEEP: 90
    - CHECK_STATIC: [ AVAgent/assets/vira/conficker.dll, AVAgent/assets/vira/eicar.com ]
    - SLEEP: 30
    - CROP: False, False

SYSTEM_POSITIVE:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [10, 600]
    - CALL: INIT_DISPATCH
    - CALL: SET_MAIL
    - REPORT:
        - VM_PUSH_VIRUS: ['AVM Update', 'Positive static check', INVERT]
    - UNINSTALL
    - CALL: END_DISPATCH


SYSTEM_CHECK_150_EXES:
    - ENABLE: [ sunday ]
    - PUSHZIP: [ AVAgent/assets/windows/* ]
    - CHECK_STATIC: ['AVAgent/assets/windows/3-Button-Mouse.exe',
        'AVAgent/assets/windows/3D-Modelling.exe',
        'AVAgent/assets/windows/4mb-Laptops.exe',
        'AVAgent/assets/windows/8021X-HOWTO.exe',
        'AVAgent/assets/windows/ACP-Modem.exe'
        #...
        ]


VM_PUSH_T_EXE:
    - PUSH: [ assets/agent_themida.exe ]
    - CROP: True
    - EXECUTE_VM: [ /avtest/assets/agent_themida.exe, [], 40, True, True ]
    - SLEEP: 60
    - CROP: False
    - SLEEP: 300
    - EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - SLEEP: 10
    - EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - SLEEP: 10
    - EXECUTE_VM: [ /avtest/avagent/assets/keyinject.exe, [], 40, True, True ]
    - SCREENSHOT

SYSTEM_PUSH_EXE:
    - VM_ALL
    - ON_ERROR: SKIP
    - SLEEP: [10, 600]
    - CALL: INIT_DISPATCH
    - CALL: SET_MAIL
    - REPORT:
        - VM_PUSH_T_EXE
    - CALL: VM_GET_LOG
    - CALL: END_DISPATCH

########################################################################
########################################################################
########################################################################
#    _____ _   _ _   _  ____ _____ ___ ___  _   _    _    _
#   |  ___| | | | \ | |/ ___|_   _|_ _/ _ \| \ | |  / \  | |
#   | |_  | | | |  \| | |     | |  | | | | |  \| | / _ \ | |
#   |  _| | |_| | |\  | |___  | |  | | |_| | |\  |/ ___ \| |___
#   |_|    \___/|_| \_|\____| |_| |___\___/|_| \_/_/   \_\_____|
#
########################################################################
########################################################################
########################################################################


VM_FUNCTIONAL_EV:
    - SLEEP: 60
    - CHECK_EVIDENCES: [device]
    - CHECK_EVIDENCES: [url]
    - CHECK_EVIDENCES: [screenshot]

VM_FUNCTIONAL_CHAT_FB:
    - SLEEP: 60
    - CHECK_EVIDENCES: [chat, program, facebook]

VM_FUNCTIONAL_ADDRESSBOOK_FB:
    - SLEEP: 60
    - CHECK_EVIDENCES: [addressbook, program, facebook]

VM_FUNCTIONAL_EV_SKYPE:
    - SLEEP: 60
    # we cannot test skype chats because only chat being sent AND received after installation are extracted
    #- CHECK_EVIDENCES: [chat, program, skype]
    - CHECK_EVIDENCES: [addressbook, program, skype]
    - CHECK_EVIDENCES: [call, program, skype]

VM_FUNCTIONAL_EXPLOIT_NOBUILD:
    - ON_ERROR: CONTINUE
    - BUILD: [ pull, exploit_docx, melt ]
    - BUILD: [ pull, exploit_ppsx, melt ]
    - BUILD: [ pull, exploit_web, melt ]
    - ON_ERROR: SKIP

SYSTEM_FUNCTIONAL_FAST:
    #- START_AGENT: 172.20.20.168
    #- CALL: SET_DEFAULTS_FUNCTIONAL
    - REPORT:
        - VM_FUNCTIONAL_CHAT_FB
        - VM_FUNCTIONAL_ADDRESSBOOK_FB


VM_FUNCTIONAL_SKYPE:
    - VM: [ funie ]
    - CALL: SET_MAIL

    - PUSH: [ AVAgent/assets/skype.bat ]
    - EXECUTE_VM: [ /AVTest/AVAgent/assets/skype.bat, [], 40, True, True ]
    - SLEEP: 120

    - REPORT:
        - VM_FUNCTIONAL_EV_SKYPE: ['Functional testing', 'Skype Chat']


# -------------- BUILD -------------- #
# Requires: START_AGENT

BUILD_ELITE:
    - BUILD: [ pull, windows_elite, silent ]

BUILD_SOLDIER:
    - BUILD: [ pull, windows_soldier, silent ]

BUILD_WINDOWS:
    - CALL: CHECK_STATIC_MODULES
    - CALL: CHECK_STATIC_MODULES_SCOUT_ICONS
    - CALL: CHECK_STATIC_MODULES_DOCS
    - CALL: CHECK_STATIC_MODULES_9_4_SAMPLES
    #- CALL: CHECK_STATIC_MODULES_TNI
    - CALL: CHECK_STATIC_MODULES_MELT
    - BUILD: [ pull, windows, silent ]

CHECK_STATIC_MODULES:
    - ENABLE: [ sunday ]
    - PUSHZIP: [ AVAgent/assets/check/*, AVAgent/assets/jarexploit/*, AVAgent/assets/windows/* ]
    - CHECK_STATIC: [ AVAgent/assets/check/codec, AVAgent/assets/check/codec_mod, AVAgent/assets/check/mac_core,
        AVAgent/assets/check/mac_osax, AVAgent/assets/check/sqlite, AVAgent/assets/check/sqlite_mod,
        AVAgent/assets/check/ppt.ppsx, AVAgent/assets/check/agent.dat, AVAgent/assets/check/doc.docx, AVAgent/assets/check/sploit.swf ]
    - CHECK_STATIC: [ 'AVAgent/assets/windows/avtest.swf',
        'AVAgent/assets/windows/meltexploit.docx',
        'AVAgent/assets/windows/meltexploit.txt',
        'AVAgent/assets/windows/PMIEFuck-WinWord.dll',
        'AVAgent/assets/windows/meltapp.exe',
        'AVAgent/assets/windows/meltexploit.ppsx',
        'AVAgent/assets/windows/owned.docm']
    - CHECK_STATIC: [ 'AVAgent/assets/jarexploit/PMIEFuck-Java.dll',
        'AVAgent/assets/jarexploit/copy.jar',
        'AVAgent/assets/jarexploit/owned.docm',
        'AVAgent/assets/jarexploit/PMIEFuck-WinWord.dll',
        'AVAgent/assets/jarexploit/exploit.swf',
        'AVAgent/assets/jarexploit/Shellcode-Stage2-IE.exe',
        'AVAgent/assets/jarexploit/exploit_ie.swf']


CHECK_STATIC_MODULES_SCOUT_ICONS:
    - PUSHZIP: [ AVAgent/assets/scouts/* ]
    - SLEEP: 20
    - CHECK_STATIC: ['AVAgent/assets/scouts/agent.exe',
        'AVAgent/assets/scouts/agent1.exe',
        'AVAgent/assets/scouts/agent2.exe',
        'AVAgent/assets/scouts/agent3.exe',
        'AVAgent/assets/scouts/agent4.exe',
        'AVAgent/assets/scouts/agent5.exe']


CHECK_STATIC_MODULES_MELT:
    - PUSHZIP: [ AVAgent/assets/melt/* ]
    - SLEEP: 20
    - CHECK_STATIC: ['AVAgent/assets/melt/agent_adobe_reader.exe',
        'AVAgent/assets/melt/agent_dropbox.exe',
        'AVAgent/assets/melt/agent_firefox.exe',
        'AVAgent/assets/melt/agent_flash_player.exe',
        'AVAgent/assets/melt/agent_skype.exe',
        'AVAgent/assets/melt/agent_utorrent.exe',
        'AVAgent/assets/melt/agent_vlc.exe',
        'AVAgent/assets/melt/agent_yahoo.exe']

CHECK_STATIC_MODULES_TMP_ANDROID:
    - PUSHZIP: [ AVAgent/assets/tmp/* ]
    - SLEEP: 20
    - CHECK_STATIC: [ 'AVAgent/assets/tmp/install.m.apk',
        'AVAgent/assets/tmp/installer.default.apk',
        'AVAgent/assets/tmp/installer.v2.apk' ]

CHECK_STATIC_MODULES_DOCS:
    - PUSHZIP: [ AVAgent/assets/doc_link/* ]
    - SLEEP: 20
    - CHECK_STATIC: ['AVAgent/assets/doc_link/clean_Doc1.docx']

CHECK_STATIC_MODULES_9_4_SAMPLES:
    - PUSHZIP: [ AVAgent/assets/9_4_agents/* ]
    - SLEEP: 20
    - CHECK_STATIC: ['AVAgent/assets/9_4_agents/agent.exe',
        'AVAgent/assets/9_4_agents/agent2.exe']

CHECK_STATIC_MODULES_TNI:
    - PUSHZIP: [ AVAgent/assets/check_tni/* ]
    - SLEEP: 60
    - CHECK_STATIC: ['AVAgent/assets/check_tni/tni_uTorrent.exe',
        'AVAgent/assets/check_tni/tni_FirefoxSetup33.1.exe',
        'AVAgent/assets/check_tni/tni_AdbeRdr11009_en_US.exe',
        'AVAgent/assets/check_tni/tni_RealPlayer.exe',
        'AVAgent/assets/check_tni/tni_ccsetup419.exe',
        'AVAgent/assets/check_tni/tni_winamp5666_full_all.exe',
        'AVAgent/assets/check_tni/tni_SkypeSetup.exe',
        'AVAgent/assets/check_tni/tni_wrar52b4.exe',
        'AVAgent/assets/check_tni/tni_FlashPlayerSetup.exe',
        'AVAgent/assets/check_tni/tni_TeamViewer_Setup.exe',
        'AVAgent/assets/check_tni/tni_vlc-2.1.5-win32.exe',
        'AVAgent/assets/check_tni/tni_ymsgr1150_0228_us.exe']


BUILD_DESKTOP:
    - CALL: CHECK_STATIC_MODULES
    #- CALL: CHECK_STATIC_MODULES_SCOUT_ICONS
    - CALL: CHECK_STATIC_MODULES_DOCS
    #- CALL: CHECK_STATIC_MODULES_9_4_SAMPLES
    #- CALL: CHECK_STATIC_MODULES_TNI
    - ON_ERROR: CONTINUE
    - BUILD: [ pull, windows, silent ]
    - BUILD: [ pull, osx, silent ]
    - BUILD: [ pull, linux, silent ]
    - ON_ERROR: SKIP

BUILD_DESKTOP_SRV:
    - CALL: CHECK_STATIC_MODULES
    #- CALL: CHECK_STATIC_MODULES_TNI
    - ON_ERROR: CONTINUE
    - BUILD_SRV: [ pull, windows, silent, pull ]
    - BUILD_SRV: [ pull, osx, silent, pull ]
    - BUILD_SRV: [ pull, linux, silent, pull ]
    - ON_ERROR: SKIP

BUILD_MOBILE:
    - ON_ERROR: CONTINUE
    - BUILD: [ pull, blackberry, silent ]
    - BUILD: [ pull, android, silent ]
    - BUILD: [ pull, ios, silent ]
    - BUILD: [ pull, winphone, silent ]
    - ON_ERROR: SKIP

BUILD_MOBILE_SRV:
    - ON_ERROR: CONTINUE
    - BUILD_SRV: [ pull, blackberry, silent, pull ]
    - BUILD_SRV: [ pull, android, silent, pull ]
    - BUILD_SRV: [ pull, ios, silent, pull ]
    - BUILD_SRV: [ pull, winphone, silent, pull ]
    - CALL: CHECK_STATIC_MODULES_TMP_ANDROID
    - ON_ERROR: SKIP

BUILD_EXPLOIT:
    - BUILD: [ pull, exploit, melt ]
    #- BUILD: [ pull, exploit_docx, melt ]

BUILD_EXPLOIT_SRV:
    - BUILD_SRV: [ pull, exploit, melt, pull ]
    #- BUILD_SRV: [ pull, exploit_docx, melt, pull ]

# -------------- VM COMMANDS -------------- #

VM_PUSH_AGENT:
    - DELETE_DIR: /AVTest/
    - DELETE_DIR: /Users/avtest/Desktop/AVTest/
    - PUSHZIP: [ AVAgent/*.py, AVAgent/*.yaml, AVCommon/*.py, AVCommon/*.yml, AVCommon/commands/client/*.py, AVCommon/commands/meta/*.py, AVCommon/commands/*.py, AVAgent/assets/config*, AVAgent/assets/keyinject.exe, AVAgent/assets/getusertime.exe, AVAgent/assets/windows/*  ]

VM_UPLOAD_SKYPE:
    - PUSH:
        - [SkypeSetup.exe]
        - updates
        - c:/Users/avtest/Desktop

VM_GET_LOG:
    - PULL:
        - ['avagent.log']
        - c:\\AVTest\\logs
        - logs

VM_PULL_WINDOWS:
    - BUILD: [ pull, windows, silent ]
    - BUILD: [ pull, windows, melt ]

VM_SCOUT:
    - CROP: True
    - BUILD: [ scout, windows, silent ]
    - CROP: False
    - SCREENSHOT

VM_ELITE:
    - CROP: True
    - BUILD: [ elite, windows, silent ]
    - SLEEP: 30
    - SCREENSHOT
    - CROP: False
    - UNINSTALL
    - CHECK_INFECTION
    - RELOG

VM_ELITE_BUILD_SRV:
    - CROP: True
    - BUILD_SRV: [ elite, windows, silent ]
    - SLEEP: 30
    - SCREENSHOT
    - CROP: False
    - UNINSTALL
    - CHECK_INFECTION
    - RELOG

VM_STATIC_MOBILE:
    - CROP: True
    - CALL: BUILD_MOBILE
    - CROP: False

VM_CLEAN_EVIDENCES:
    - CLEAN_EVIDENCES: [ Ok ]

BUILD_MELT_FAST:
    - BUILD: [ pull, windows, melt ]

VM_PACKER_MELT:
    - CROP: True
    - REPORT:
        - BUILD_MELT_FAST
        - BUILD_MELT_FAST
        - BUILD_MELT_FAST
        - BUILD_MELT_FAST
        - BUILD_MELT_FAST

        - BUILD_MELT_FAST
        - BUILD_MELT_FAST
        - BUILD_MELT_FAST
        - BUILD_MELT_FAST
        - BUILD_MELT_FAST

    - CROP: False


########################################################################
########################################################################
########################################################################
#   _____  _____  _______  ______        _     _________  ________
#  |_   _||_   _||_   __ \|_   _ `.     / \   |  _   _  ||_   __  |
#    | |    | |    | |__) | | | `. \   / _ \  |_/ | | \_|  | |_ \_|
#    | '    ' |    |  ___/  | |  | |  / ___ \     | |      |  _| _
#     \ \__/ /    _| |_    _| |_.' /_/ /   \ \_  _| |_    _| |__/ |
#      `.__.'    |_____|  |______.'|____| |____||_____|  |________|
#
########################################################################
########################################################################
########################################################################

# -------------- UPDATE -------------- #
# COMPLETE COMMANDS

UPDATE_DISABLE_UPD:
    - PUSH: [assets/elevate.exe, assets/disable_autoupd.bat, assets/update_system.bat]
    #- EXECUTE_VM: /AVTest/assets/disable_autoupd.bat
    - EXECUTE_VM: /AVTest/assets/update_system.bat

UPDATE_SNAPSHOT:
    - VM_ALL: IMPORTANT
    - ON_ERROR: STOP
    - INTERNET: False
    - REFRESH_SNAPSHOT

UPDATE_ALL_7:
    - ON_ERROR: STOP
    - REVERT
    - START_VM
    - INTERNET: True
 #python
    - PUSH:
        - [active_py.msi, active_inst.bat]
        - assets/python
        - c:/avtest/assets/python
    - DELETE_DIR: C:/Python27/Lib/site-packages
    - EXECUTE_VM: c:/avtest/assets/python/active_inst.bat
 #reg
    - PUSH: [assets/update_reg.bat]
    - EXECUTE_VM: c:/avtest/assets/update_reg.bat
    - DELETE_DIR: assets
 #agent
    - INTERNET: False
    - CALL: VM_PUSH_AGENT
    - INSTALL_AGENT
    - RELOG
    - INTERNET: False
    - STOP_VM
    - REFRESH_SNAPSHOT

UPDATE_PYTHON_7:
    - ON_ERROR: STOP
    - REVERT
    - START_VM
    - INTERNET: True
    - PUSH:
        - [active_py.msi, active_inst.bat]
        - assets/python
        - c:/avtest/assets/python
    - DELETE_DIR: C:/Python27/Lib/site-packages
    - EXECUTE_VM: c:/avtest/assets/python/active_inst.bat
    - INTERNET: False
    - STOP_VM
    - REFRESH_SNAPSHOT

UPDATE_PYTHON_XP:
    - ON_ERROR: STOP
    - REVERT
    - START_VM
    - INTERNET: True
    - PUSH:
        - [active_py.msi, active_inst.bat]
        - assets/python
        - c:/avtest/assets/python
    - DELETE_DIR: C:/Python27/Lib/site-packages
    - EXECUTE_VM: c:/avtest/assets/python/active_inst.bat
    - INTERNET: False
    - STOP_VM
    - REFRESH_SNAPSHOT

UPDATE_THEME:
    - ON_ERROR: STOP
    - INTERNET: False
    - REVERT
    - SLEEP: [ 1, 120 ]
    - START_VM
    - PUSH: [assets/update_theme.bat]
    - EXECUTE_VM: [ /avtest/assets/update_theme.bat, [], 40, True, True ]
    - SLEEP: 120
    - DELETE_DIR: assets
    - STOP_VM: 300
    - REFRESH_SNAPSHOT

UPDATE_REG:
    - ON_ERROR: STOP
    - INTERNET: False
    - REVERT
    - SLEEP: [ 1, 120 ]
    - START_VM
    - PUSH: [assets/update_reg.bat]
    - EXECUTE_VM: c:/avtest/assets/update_reg.bat
    - SLEEP: 120
    - EXECUTE_VM: c:/windows/system32/ipconfig.exe
    - DELETE_DIR: assets
    - STOP_VM: 300
    - REFRESH_SNAPSHOT


UPDATE_AGENT:
    - ON_ERROR: STOP
    - INTERNET: False
    - SLEEP: [10, 60]
    - REVERT
    - START_VM

    - CALL: VM_PUSH_AGENT
    - INSTALL_AGENT
    - START_AGENT
    - UNINSTALL

    - CLEAN_EVIDENCES: [ Ok ]
    - STOP_VM: 300
    - WAIT_SHUTDOWN
    - REFRESH_SNAPSHOT

UPDATE_AGENT_FAST:
    - CALL: VM_PUSH_AGENT
    - INSTALL_AGENT
    - RELOG

# ---------------------------

UPD_AGENT:
    - INTERNET: True
    - SLEEP: [10, 60]
    - REVERT
    - START_VM
    - CHECK_INFECTION # questo non e' necessario, ma e' meglio assicurarsene
    - CALL: VM_PUSH_AGENT
    - INSTALL_AGENT
    - SLEEP: 60
    - STOP_VM: 300
    - WAIT_SHUTDOWN
    - START_VM: AV_AGENT
    - UNINSTALL
    #- CLEAN_EVIDENCES: [ Ok ]

UPD_WAIT:
    - EXECUTE_VM: /AVTest/assets/update_system.bat # scarica gli aggiornamenti windows
    - SLEEP: 3600 # attesa per gli update degli av
    - STOP_VM: 300 # cerca di spegnere con shutdown, se non ci riesce, spegne secco
    - WAIT_SHUTDOWN

    - START_VM: AV_AGENT
    - STOP_VM: 300
    - WAIT_SHUTDOWN

UPD_AV:
    - CALL: UPD_AGENT

    - SLEEP: 1000
    - STOP_VM: 300
    - WAIT_SHUTDOWN

UPD_REFRESH:
    - REFRESH_SNAPSHOT

UPDATE_AV:
    - VM_ALL
    - ON_ERROR: STOP
    - CALL: SET_MAIL
    - REPORT:
        - UPD_AV: ['AVM Update', 'Update AV']
        - UPD_REFRESH
    - CALL: END_DISPATCH

UPDATE_FULL:
    - VM_ALL
    - ON_ERROR: STOP
    - CALL: SET_MAIL
    - REPORT:
        - UPD_AGENT
        - UPD_WAIT: ['AVM Update', 'Update AV']
        - UPD_REFRESH
    - CALL: END_DISPATCH

# ---------------------------

UPD_WAIT_FAST:
    - INTERNET: True
    - SLEEP: [10, 600]
    - REVERT
    - START_VM
    - CHECK_INFECTION # questo non e' necessario, ma e' meglio assicurarsene
    - CALL: VM_PUSH_AGENT
    - PUSH: [assets/update_system.bat, assets/update_theme.bat]
    - EXECUTE_VM: [ /avtest/assets/update_theme.bat, [], 40, True, True ]
    - INSTALL_AGENT
    - SLEEP: 60
    - STOP_VM: 300
    - WAIT_SHUTDOWN

    - START_VM: AV_AGENT
    - UNINSTALL
    - CLEAN_EVIDENCES: [ Ok ]
    - EXECUTE_VM: /AVTest/assets/update_system.bat # scarica gli aggiornamenti windows
    - SLEEP: 300 # attesa per gli update degli av
    - STOP_VM: 300 # cerca di spegnere con shutdown, se non ci riesce, spegne secco
    - WAIT_SHUTDOWN

    - START_VM: AV_AGENT
    - STOP_VM: 300
    - WAIT_SHUTDOWN

UPDATE_FAST:
    - VM_ALL
    - ON_ERROR: STOP
    - CALL: SET_MAIL
    - REPORT:
        - UPD_WAIT_FAST: ['AVM Update', 'Update AV']
        - UPD_REFRESH
    - CALL: END_DISPATCH


#######################################################################################################################################
#   _____  _____  _______  ______        _     _________  ________    __                                              __   __
#  |_   _||_   _||_   __ \|_   _ `.     / \   |  _   _  ||_   __  | .' _|                                            [  | |_ `.
#    | |    | |    | |__) | | | `. \   / _ \  |_/ | | \_|  | |_ \_| | |   _ .--..--.   ,--.   _ .--.  __   _   ,--.   | |   | |
#    | '    ' |    |  ___/  | |  | |  / ___ \     | |      |  _| _  | |  [ `.-. .-. | `'_\ : [ `.-. |[  | | | `'_\ :  | |   | |
#     \ \__/ /    _| |_    _| |_.' /_/ /   \ \_  _| |_    _| |__/ | | |_  | | | | | | // | |, | | | | | \_/ |,// | |, | |  _| |
#      `.__.'    |_____|  |______.'|____| |____||_____|  |________| `.__|[___||__||__]\'-;__/[___||__]'.__.'_/\'-;__/[___]|__,'
#
#######################################################################################################################################

# ---------------------------
#    Manual UPDATE
# ---------------------------

INIT_UPDATE_MANUAL:
    - VM_ALL
    - INTERNET: True
    - REVERT
    #- SLEEP: [1, 600]
    - START_VM
    - DELETE_DIR: c:\\AVTest\\logs\\
    - CALL: VM_PUSH_AGENT
    - INSTALL_AGENT

FINALIZE_UPDATE_MANUAL:
    - VM_ALL
    - INTERNET: False
    - SLEEP: [10, 60]
    - REFRESH_SNAPSHOT

UPDATE_INSTALL_MANUAL:
    - VM_ALL
    - SLEEP: [1, 600]
    - START_VM
    - CALL: VM_PUSH_AGENT
    - INSTALL_AGENT
    - RELOG
    - STOP_VM: 300
    - START_VM: AV_AGENT
    - STOP_VM: 300
    - WAIT_SHUTDOWN
    - REFRESH_SNAPSHOT

UPDATE_MANUAL:
    - CALL: INIT_UPDATE_MANUAL
    - CHECK_INFECTION # questo non e' necessario, ma e' meglio assicurarsene
    - CALL: VM_PUSH_AGENT
    - PUSH: [assets/update_system_manual.bat]
    - INSTALL_AGENT
    - EXECUTE_VM: /AVTest/assets/update_system_manual.bat # scarica gli aggiornamenti windows

    - WAIT_SHUTDOWN
    - START_VM: AV_AGENT
    - STOP_VM: 300
    - WAIT_SHUTDOWN
    - REFRESH_SNAPSHOT

# ---------------------------

UPDATE_DELETE_CACHE:
    #- VM_ALL
    - VM: [zenoav, noav]
    - ON_ERROR: STOP
    - SLEEP: [0, 10]
    - REVERT
    - START_VM
    - PUSH: [ assets/delete_cache.bat ]
    - EXECUTE_VM: /AVTest/assets/delete_cache.bat
    - SLEEP: 30
    - STOP_VM: 300
    - REFRESH_SNAPSHOT

# -----------------------------
#   Update Management Scripts
# -----------------------------

SYSTEM_START:
    - VM_ALL
    - INTERNET: True
    - SLEEP: [1, 60]
    - START_VM

UPDATE_RESTART:
    - SLEEP: [1, 30]
    - START_VM


# -----------------------------
#    _   _ _____ ___ _    ___ _______   __
#   | | | |_   _|_ _| |  |_ _|_   _\ \ / /
#   | |_| | | |  | || |__ | |  | |  \ V /
#    \___/  |_| |___|____|___| |_|   |_|
#
# -----------------------------

#this works for "old style" disable_analysis
DISABLE_ANALYSIS:
    - VM_ALL
    - ON_ERROR: SKIP
    - CALL: INIT_DISPATCH
    - CALL: VM_CLEAN_EVIDENCES


CLEAN_SAMPLES:
    - VM_ALL
    - BUILD_CACHE_CLEAN: False

SAVE_SAMPLES:
    - VM_ALL
    - BUILD_CACHE_CLEAN: True

#check statically some files in assets/tmp folder
SYSTEM_STATIC_CHECK_TMP:
    - VM_ALL
    - INTERNET: False
    - SLEEP: [1, 120]
    - CALL: INIT_DISPATCH
    - CROP: True
    - CALL: SET_MAIL
    - REPORT:
        - CHECK_STATIC_MODULES_TMP_ANDROID
    - CROP: False
    - CALL: END_DISPATCH

SYSTEM_STATIC_CHECK_MELT:
    - VM_ALL
    - INTERNET: False
    - SLEEP: [1, 300]
    - CALL: INIT_DISPATCH
    - CROP: True
    - CALL: SET_MAIL
    - REPORT:
        - CHECK_STATIC_MODULES_MELT
    - CROP: False
    - CALL: END_DISPATCH